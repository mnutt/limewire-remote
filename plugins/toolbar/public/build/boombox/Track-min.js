/*
 * Fab's BoomBox
 * Copyright(c) 2006, Mark Fabrizio Jr..
 * 
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */


Fabs.boombox.Track=Ext.extend(Ext.util.Observable,{url:'',title:'',songname:'',artist:'',track:'',album:'',year:'',volume:70,position:0,autoLoad:false,playing:false,started:false,constructor:function(config){if(typeof config=='string'){config={url:config,name:''};}
Ext.apply(this,config);this.id=this.id||Fabs.boombox.generateTrackId();this.addEvents.apply(this,Fabs.boombox.smSoundEvents);this.addEvents('stop','loaderror','infochange','statechange');this.addEvents('ready');Fabs.boombox.Track.superclass.constructor.call(this);this.id3=false;this.on('id3',this.onID3,this);this.on('load',this.onLoad,this);this.on('whileplaying',this.onWhilePlaying,this);this.on('play',this.onPlay,this);this.on('resume',this.onResume,this);this.on('pause',this.onPause,this);this.on('finish',this.onFinish,this);this.loaded=false;this.ready=false;this.playing=false;this.started=false;if(this.autoLoad){this.load();}},fireOnReady:function(){this.ready=true;this.fireEvent('ready',this);},onReady:function(fn,scope){if(!this.ready){this.on('ready',fn,scope);if(!this.loaded){this.load();}}
else{fn.apply(scope,[this]);}},getProgressPercent:function(){var p=0;if(this.soundObject){p=this.position/(this.soundObject.readyState==3?this.soundObject.duration:this.soundObject.durationEstimate)*100;}
return p;},setProgressByPercent:function(p){if(this.soundObject){p=p/100*(this.soundObject.readyState==3?this.soundObject.duration:this.soundObject.durationEstimate);this.soundObject.setPosition(p);this.position=p;}},load:function(callback,scope){if(this.loaded){return false;}
var cfg={id:this.id,url:this.url,autoLoad:this.autoLoad||false,autoPlay:this.autoPlay||false};Ext.each(Fabs.boombox.smSoundEvents,function(ev){var name=ev.indexOf('while')===0?ev:'on'+ev;cfg[name]=this.handleSMEvent.createDelegate(this,[ev],0);},this);Fabs.boombox.onSoundManagerReady(function(){this.soundObject=soundManager.createSound(cfg);this.soundObject.setVolume(this.volume);this.loaded=true;this.fireOnReady();},this);return true;},isPlaying:function(){return this.playing;},hasSongInfo:function(){var songInfo=true;Ext.each(arguments||['songname','artist'],function(field){if(!this[field]||this[field]==''){songInfo=false;return false;}
return true;},this);return songInfo;},play:function(){this.onReady(function(){this.soundObject[this.started?'resume':'play']();},this);return this;},pause:function(){if(this.playing&&this.soundObject){this.soundObject.pause();}
return this;},stop:function(){if(this.soundObject){this.soundObject.stop();this.started=false;this.playing=false;this.position=0;this.fireEvent('stop',this);this.fireEvent('statechange',this);this.fireEvent('positionchange',this);}
return this;},setVolume:function(level){this.volume=level;this.onReady(function(){this.soundObject.setVolume(level);},this);return this;},handleSMEvent:function(ev){var args=Array.prototype.slice.apply(arguments,[0]);args.splice(1,0,this);this.fireEvent.apply(this,args);},unload:function(){if(this.soundObject){soundManager.destroySound(this.id);}},onWhilePlaying:function(){this.position=this.soundObject.position;this.fireEvent('positionchange',this);},onID3:function(id3){this.id3=this.soundObject.id3;var props=['songname','artist','album','track','year'];Ext.each(props,function(prop){if(this[prop]==""){this[prop]=this.id3[prop]||'';}},this);if(!this.title&&this.songname&&this.artist){this.title=this.artist+' - '+this.songname;}
this.fireEvent("infochange",this);},onPlay:function(){this.started=true;this.playing=true;this.fireEvent('statechange',this);},onResume:function(){this.started=true;this.playing=true;this.fireEvent('statechange',this);},onPause:function(){this.playing=false;this.fireEvent('statechange',this);},onFinish:function(){this.started=false;this.playing=false;this.fireEvent('statechange',this);},onLoad:function(){if(this.soundObject.readyState===2){this.loadError=true;this.loaded=false;this.ready=false;soundManager.destroySound(this.id);delete(this.soundObject);this.fireEvent('loaderror',this);}}});